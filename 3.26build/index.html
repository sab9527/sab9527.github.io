<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>遊戲資料瀏覽器</title>
    <style>
        body {
            font-family: 'Segoe UI', '微軟正黑體', Arial, sans-serif;
            margin: 0;
            /* 請將下行網址替換為你想要的圖片網址 */
            background: #181c20 url('https://upload-os-bbs.hoyolab.com/upload/2023/05/10/248389752/f169af109b5d93fc3c884170d2213c09_6832829586940383967.jpg?x-oss-process=image%2Fresize%2Cs_1000%2Fauto-orient%2C0%2Finterlace%2C1%2Fformat%2Cwebp%2Fquality%2Cq_70') no-repeat center center fixed;
            background-size: cover;
            color: #e0e0e0;
            min-height: 100vh;
        }
        h2 {
            text-align: center;
            margin-top: 32px;
            color: #f5dbb5;
            letter-spacing: 2px;
            text-shadow: 0 2px 8px #000a;
        }
        .upload-block {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 24px 0 0 0;
        }
        .upload-block label {
            background: #23272e;
            color: #ffb84d;
            border-radius: 8px;
            padding: 8px 18px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 12px;
            border: 1.5px solid #ffb84d;
            transition: background 0.2s, color 0.2s;
        }
        .upload-block input[type="file"] {
            display: none;
        }
        .filter-group {
            margin: 32px auto 24px auto;
            padding: 24px 32px;
            background: #263c61;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(45, 219, 196, 0.986);
            max-width: 900px;
            display: flex;
            flex-wrap: wrap;
            gap: 24px 32px;
            justify-content: center;
        }
        .filter-block {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap;   /* 新增：同一行不換行 */
        }
        .filter-label {
            color: #ffb84d;
            font-weight: bold;
            margin-right: 8px;
            white-space: nowrap; /* 新增：防止換行 */
        }
        .filter-btn {
            background: #23272e;
            color: #e0e0e0;
            border: 1.5px solid #444;
            border-radius: 6px;
            padding: 4px 14px;
            margin: 2px 2px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, border 0.2s;
            font-size: 15px;
        }
        .filter-btn.active {
            background: #ffb84d;
            color: #23272e;
            border: 1.5px solid #ffb84d;
            font-weight: bold;
            box-shadow: 0 2px 8px #ffb84d44;
        }
        table {
            width: 96%;
            margin: 0 auto 40px auto;
            border-collapse: collapse;
            background: #23272e;
            box-shadow: 0 4px 24px #0008;
            border-radius: 12px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #333a;
            padding: 10px 8px;
            text-align: center;
        }
        td {
            white-space: nowrap; /* 禁止換行 */
            overflow: hidden;    /* 隱藏超出部分 */
            text-overflow: ellipsis; /* 超出部分顯示省略號 */
        }

        td:last-child {
            white-space: normal; /* 允許換行 */
        }
        th {
            background: #1a1e23;
            color: #ffb84d;
            font-size: 16px;
            letter-spacing: 1px;
            white-space: nowrap;
        }
        tr:nth-child(even) {
            background: #23272e;
        }
        tr:nth-child(odd) {
            background: #181c20;
        }
        .video-embed {
            width: 220px;
            height: 124px;
            border-radius: 6px;
            border: none;
            background: #111;
        }
        a { color: #7ecfff; text-decoration: underline; }
        a:hover { color: #ffb84d; }
        @media (max-width: 900px) {
            .filter-group { flex-direction: column; align-items: stretch; }
            table, th, td { font-size: 13px; }
            .video-embed { width: 140px; height: 80px; }
        }
        tbody.fade {
            opacity: 0;
            transition: opacity 0.3s;
        }
        tbody {
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>
    <h2>遊戲資料瀏覽器</h2>
    <div style="display:none;"></div>
    <div class="filter-group" id="filter-group"></div>
    <table id="games-table">
        <thead>
            <tr>
                <th>流派名稱</th>
                <th>昇華</th>
                <th>擅長分類</th>
                <th>傷害類型</th>
                <th>作者</th>
                <th>影片連結</th>
                <th>說明</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div id="video-modal-mask" style="display:none;position:fixed;z-index:10000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;">
        <div id="video-modal-content" style="position:relative;background:none;">
            <span id="video-modal-close" style="position:absolute;top:-32px;right:0;font-size:32px;color:#fff;cursor:pointer;">&times;</span>
            <iframe id="video-modal-iframe" width="560" height="315" style="border-radius:12px;border:none;box-shadow:0 4px 24px #000a;background:#111;" allowfullscreen></iframe>
        </div>
    </div>
    <script>
    const filterOptions = {
        '昇華': ['野蠻人','女巫','聖騎士','貴族','遊俠','決鬥者','暗影刺客'],
        '擅長分類': ['打王','打圖','均衡','特化'],
        '傷害類型': ['火焰','閃電','冰冷','物理','渾沌','直擊','持續','召喚','圖騰','法術','攻擊','弓']
    };
    function createModernFilters() {
        const filterGroup = document.getElementById('filter-group');
        filterGroup.innerHTML = '';
        Object.keys(filterOptions).forEach(field => {
            const block = document.createElement('div');
            block.className = 'filter-block';
            const label = document.createElement('span');
            label.className = 'filter-label';
            label.textContent = field;
            block.appendChild(label);
            filterOptions[field].forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.textContent = opt;
                btn.dataset.field = field;
                btn.dataset.value = opt;
                btn.onclick = function() {
                    btn.classList.toggle('active');
                    renderTable(window._gameData, getCurrentFilters());
                };
                block.appendChild(btn);
            });
            filterGroup.appendChild(block);
        });
    }
    function getCurrentFilters() {
        const activeBtns = Array.from(document.querySelectorAll('.filter-btn.active'));
        const filters = {};
        activeBtns.forEach(btn => {
            if (!filters[btn.dataset.field]) filters[btn.dataset.field] = [];
            filters[btn.dataset.field].push(btn.dataset.value);
        });
        return filters;
    }
    function matchFilters(row, filters) {
        for (let key in filters) {
            // 支援多值（以, 或 、分隔）
            const cell = (row[key] || '').split(/,|、/).map(s => s.trim());
            // 只要有一個符合即可
            if (!filters[key].some(val => cell.includes(val))) return false;
        }
        return true;
    }
    function renderTable(data, filters) {
        const tbody = document.querySelector('#games-table tbody');
        // 動畫：先淡出
        tbody.classList.add('fade');
        setTimeout(() => {
            tbody.innerHTML = '';
            data.filter(row => {
                if (Object.keys(filters).length === 0) return true;
                return matchFilters(row, filters);
            }).forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row['流派名稱']||''}</td>
                    <td>${row['昇華']||''}</td>
                    <td>${row['擅長分類']||''}</td>
                    <td>${row['傷害類型']||''}</td>
                    <td>${row['作者']||''}</td>
                    <td>${embedVideo(row['影片連結'])}</td>
                    <td>${row['說明']||''}</td>
                `;
                tbody.appendChild(tr);
            });
            // 動畫：再淡入
            tbody.classList.remove('fade');
        }, 200);
    }
    function embedVideo(url) {
        if (!url) return '無影片連結';
        // 只支援 YouTube
        const ytMatch = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/))([\w-]{11})/);
        if (!ytMatch) {
            return `<a href="${url}" target="_blank">查看影片</a>`;
        }
        const vid = ytMatch[1];
        const thumb = `https://img.youtube.com/vi/${vid}/hqdefault.jpg`;
        // 直接顯示縮圖，點擊彈窗
        return `<img src="${thumb}" class="video-thumb" data-vid="${vid}" style="cursor:pointer;max-width:120px;border-radius:8px;box-shadow:0 2px 12px #000a;">`;
    }

    const FIELD_MAP = ["流派名稱", "昇華", "擅長分類", "傷害類型", "作者", "影片連結", "說明"];

    function parseCSV(text) {
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
        const header = lines[0].split(',');
        return lines.slice(1).map(line => {
            const values = line.split(',');
            const obj = {};
            FIELD_MAP.forEach((key, idx) => {
                obj[key] = values[idx] || '';
            });
            return obj;
        });
    }

    async function loadCSVData() {
        try {
            const res = await fetch('data.csv?_=' + Date.now());
            if (!res.ok) throw new Error('無法載入 data.csv');
            const text = await res.text();
            const json = parseCSV(text);
            window._gameData = json;
            createModernFilters();
            renderTable(json, {});
        } catch (e) {
            console.error('載入 CSV 失敗', e);
            alert('載入 data.csv 失敗：' + e.message);
        }
    }

    window.onload = function () {
        loadCSVData();
    };

    // 建立預覽元素
    const preview = document.createElement('div');
    preview.style.position = 'fixed';
    preview.style.pointerEvents = 'none';
    preview.style.display = 'none';
    preview.style.zIndex = 9999;
    preview.innerHTML = '<img src="" style="max-width:240px;max-height:135px;border-radius:8px;box-shadow:0 2px 12px #000a;">';
    document.body.appendChild(preview);

    document.addEventListener('mouseover', function(e) {
        const link = e.target.closest('.video-link');
        if (link && link.dataset.thumb) {
            const img = preview.querySelector('img');
            img.src = link.dataset.thumb;
            preview.style.display = 'block';
        }
    });
    document.addEventListener('mousemove', function(e) {
        if (preview.style.display === 'block') {
            preview.style.left = (e.clientX + 20) + 'px';
            preview.style.top = (e.clientY + 20) + 'px';
        }
    });
    document.addEventListener('mouseout', function(e) {
        const link = e.target.closest('.video-link');
        if (link) {
            preview.style.display = 'none';
        }
    });

    // 彈窗播放影片
    const modalMask = document.getElementById('video-modal-mask');
    const modalIframe = document.getElementById('video-modal-iframe');
    const modalClose = document.getElementById('video-modal-close');

    document.addEventListener('click', function(e) {
        const thumb = e.target.closest('.video-thumb');
        if (thumb && thumb.dataset.vid) {
            modalMask.style.display = 'flex';
            modalIframe.src = `https://www.youtube.com/embed/${thumb.dataset.vid}?autoplay=1`;
        }
        if (e.target === modalMask || e.target === modalClose) {
            modalMask.style.display = 'none';
            modalIframe.src = '';
        }
    });
    </script>
</body>
</html>